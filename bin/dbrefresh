#!/bin/bash
ENVFILE=".env.local"

if [ ! -f ./bin/console ]; then
  echo "Run this script in project root directory"
  exit 1
fi

up_mode=""

for ((i=1;i<=$#;i++));
do

    if [ ${!i} = "--env" ]
    then ((i++))
        ENVFILE=".env.${!i}";
        ENVKEY=".${!i}";
    fi

    if [ ${!i} = "--both" ]
    then
       up_mode="both"
    fi
done;

if [ ! -f "$ENVFILE" ]
then
  if [[ $ENVFILE == ".env.local" && -f ".env" ]]
  then
    ENVFILE=".env"
  else
    echo "Cannot find file ${ENVFILE}..."
    exit
  fi
fi

if [[ $ENVFILE == ".env.local" || $ENVFILE == ".env" ]]
then
  ENVKEY=""
fi

function doctrine_update_local {
  ./bin/console doctrine:database:drop --force
  rm src/Migrations/Version*.php
  ./bin/console doctrine:database:create
  ./bin/console make:migration
  ./bin/console doctrine:migrations:migrate
}

function doctrine_update_test {
  ./bin/console doctrine:database:drop --force --env test
  ./bin/console doctrine:database:create --env test
  ./bin/console doctrine:migrations:migrate --env test
}

if [ "$ENVKEY" = "" ]; then
  echo "Clean local database and reload fixtures..."
  doctrine_update_local
elif [ "$ENVKEY" = ".test" ]; then
  echo "Clean test environment database..."
  doctrine_update_test
elif [ "$up_mode" = "both" ]; then
  echo "Clean both local and test databases..."
  doctrine_update_local
  doctrine_update_test
fi
